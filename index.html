<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel de Produtividade V16 (Fila Corrigida - Final)</title>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<style>
/* NOVO ESTILO: TELA DE LOGIN */
#login-screen {
max-width: 400px;
margin: 100px auto;
padding: 30px;
background: white;
border-radius: 8px;
box-shadow: 0 4px 10px rgba(0,0,0,0.1);
text-align: center;
}
#login-screen input {
width: 100%;
margin-bottom: 15px;
box-sizing: border-box;
}
#app-content {
display: none;
}
/* --- ESTILOS GERAIS --- */
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; }
h2, h3 { border-bottom: 2px solid #007bff; padding-bottom: 8px; color: #333; }
button { padding: 10px 15px; border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; font-size: 16px; }
button:disabled { background-color: #6c757d; cursor: not-allowed; }
input[type="text"],
input[type="email"],
input[type="password"],
select {
padding: 12px;
height: auto;
border: 1px solid #ccc;
border-radius: 4px;
font-size: 16px;
width: 100%;
box-sizing: border-box;
}
.btn-play { background-color: #28a745; }
.btn-stop { background-color: #dc3545; }
.btn-primary { background-color: #007bff; }
.btn-delete { background-color: #7a7a7a; font-size: 14px; padding: 5px 10px; }
.btn-secondary { background-color: #6c757d; }
.btn-clock-in { background-color: #17a2b8; }
.btn-clock-out { background-color: #ffc107; color: #333; }
/* --- NAVEGAÇÃO --- */
nav { background-color: #343a40; padding: 15px 24px; display: flex; gap: 15px; flex-wrap: wrap; }
nav button { background-color: #6c757d; font-size: 14px; }
nav button.active { background-color: #007bff; box-shadow: 0 0 0 2px rgba(0,123,255,.5); }
.view-container { padding: 24px; display: none; }
#view-queue { display: block; } /* Default view set to the new queue screen */
/* === LAYOUTS DE PAINEL (GRID - DESKTOP - NO SCROLL) === */
@media (min-width: 1200px) {
/* Layout base para as views de produção e fila */
.view-container .container {
display: grid;
gap: 24px;
height: calc(100vh - 80px - 48px - 60px); /* Altura total da tela menos header/nav/padding */
min-height: 550px;
}
/* Layout da Nova Tela de Fila/Entrada */
#view-queue .container {
grid-template-columns: 370px 1fr; /* Coluna de Formulário (fixa) e Coluna de Filas (flexível) */
}
/* *NOVO* Layout da Tela de Produção: 3 Colunas Iguais */
#view-production .container {
grid-template-columns: 1fr 1fr 1fr;
}
.panel-column {
display: flex;
flex-direction: column;
gap: 15px;
overflow-y: hidden; /* Coluna não rola */
}
/* Seção do formulário/disponíveis (não rola) */
.panel-column .admin-section {
flex-shrink: 0;
background: #fff;
padding: 20px;
border-radius: 8px;
box-shadow: 0 2px 4px rgba(0,0,0,0.1);
flex-grow: 1; /* Garante que o formulário de Iniciar Serviço preencha a altura da coluna */
overflow-y: auto; /* Permite scroll no formulário, se necessário */
}
/* Container das 3 Filas */
#categorized-queues-container {
flex-grow: 1; /* Ocupa o restante da coluna */
display: grid;
grid-template-columns: 1fr 1fr 1fr; /* 3 colunas iguais para as 3 filas */
gap: 15px;
overflow-y: hidden; /* Container de Filas não rola */
}
/* Listas Internas (Em Andamento, Disponíveis, Filas Categorizadas) */
.inner-scroll-list {
flex-grow: 1;
overflow-y: auto; /* ROLAGEM INTERNA */
min-height: 200px; /* Garante que listas vazias têm altura */
background: #ffffff;
padding: 15px;
border-radius: 8px;
box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
/* Ajuste para a seção de Funcionários Disponíveis */
#available-mechanics-section {
flex-grow: 1;
padding: 15px;
background: #ffffff;
border-radius: 8px;
box-shadow: 0 2px 4px rgba(0,0,0,0.05);
overflow-y: auto; /* Rolagem interna */
}
/* Ajuste para garantir que o formulário de Fila se expanda */
#new-queue-form { display: flex; flex-direction: column; gap: 15px; height: 100%;} /* Ajuste de altura */
#queue-services-container { overflow-y: auto; max-height: 200px; padding: 5px; border: 1px solid #eee; border-radius: 4px; }
}
/* FIM DO NOVO LAYOUT PAINEL */
.sidebar { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
#new-service-form { display: flex; flex-direction: column; gap: 15px; height: 100%; } /* Garante que o form preencha o admin-section */
#available-mechanics-section h3 { border-bottom: 1px dashed #007bff; padding-bottom: 4px; margin-top: 15px; margin-bottom: 10px; }
.available-list-group { display: flex; flex-direction: column; gap: 4px; }
.mechanic-tag { display: flex; justify-content: space-between; align-items: center; background-color: #e9ecef; color: #333; padding: 8px 12px; border-radius: 4px; font-size: 16px;
font-weight: 500; }
.mechanic-tag .position { background-color: #007bff; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 14px; margin-right: 10px; }
.mechanic-tag:first-child { border: 2px solid #28a745; background-color: #d4edda; }
.available-list-group:empty::after { content: "Nenhum disponível nesta função."; color: #777; font-style: italic; padding: 5px 0;}
.main-content { display: flex; flex-direction: column; gap: 15px; }
@media (min-width: 900px) { .service-row { display: grid; grid-template-columns: 1.5fr 3fr 1fr 1fr 1fr; align-items: center; gap: 12px; } }
.service-row { background-color: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.time-display { font-family: 'Courier New', Courier, monospace; font-size: 16px; background-color: #e9ecef; padding: 10px; border-radius: 4px; text-align: center; }
/* Estilos para o item da fila */
.queue-item {
background-color: #f8f8f8;
padding: 10px;
border-radius: 6px;
margin-bottom: 8px;
border-left: 4px solid #007bff;
font-size: 14px;
}
.queue-item p { margin: 3px 0; }
.queue-item button {
width: 100%;
margin-top: 8px;
padding: 8px;
font-size: 14px;
}
/* === OUTROS ESTILOS MANTIDOS === */
/* ... (estilos para view-report, view-timeclock, view-config) ... */
/* === TELA 2: RELATÓRIO DIÁRIO === */
#report-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 10px 0; }
.mechanic-report-group { background-color: #fff; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.mechanic-report-group h3 { border-bottom: 2px solid #28a745; color: #28a745; }
.service-report-row { display: grid; grid-template-columns: 3fr 1fr 1fr 1fr; border-bottom: 1px dashed #eee; padding: 10px 0; font-size: 15px; }
.report-summary { font-weight: bold; margin-top: 15px; padding-top: 10px; border-top: 1px solid #ccc; }
/* === TELA 3: REGISTRO DE PONTO === */
#view-timeclock .timeclock-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
.timeclock-card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 10px; }
.timeclock-card h3 { margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 10px; font-size: 18px; }
.timeclock-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
.timeclock-status { font-weight: bold; text-align: center; padding: 5px; border-radius: 4px; }
.status-on { background-color: #d4edda; color: #155724; }
.status-off { background-color: #f8d7da; color: #721c24; }
.status-break { background-color: #fff3cd; color: #856404; }
/* === TELA 4: ADMINISTRAÇÃO === */
#view-config .config-container { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
.admin-section { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.admin-form { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
.admin-list ul { list-style: none; padding: 0; }
.admin-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
/* === AJUSTES PARA MOBILE === */
@media (max-width: 1199px) {
.sidebar { position: static; }
nav { flex-wrap: wrap; padding: 10px; }
nav button { width: calc(50% - 7.5px); margin-bottom: 5px; }
.service-row { display: grid; grid-template-columns: 1fr 1fr; grid-template-areas: "mech mech" "desc desc" "inicio duracao" "btn btn"; gap: 8px; padding: 15px;
}
.service-row strong { grid-area: mech; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.service-row .service-desc { grid-area: desc; font-size: 18px; font-weight: bold; }
.service-row > *:nth-child(3) { grid-area: inicio; text-align: left; }
.service-row > *:nth-child(4) { grid-area: duracao; text-align: right; }
.service-row > *:nth-child(3) span, .service-row > *:nth-child(4) span { background-color: #e9ecef; padding: 8px; border-radius: 4px; }
.service-row .btn-stop { grid-area: btn; }
#view-config .config-container { grid-template-columns: 1fr; }
.service-report-row { grid-template-columns: 1fr 1fr; grid-template-areas: "servico duracao" "inicio fim"; gap: 5px 10px; padding: 8px 0; }
.service-report-row span:nth-child(1) { grid-area: servico; font-weight: bold; }
.service-report-row span:nth-child(4) { grid-area: duracao; color: #dc3545; text-align: right; }
.admin-list li { flex-direction: column; align-items: flex-start; gap: 5px; }
/* Ajustes para as 3 colunas de fila em mobile */
#categorized-queues-container { grid-template-columns: 1fr; }
.inner-scroll-list { max-height: 400px; }
}
.logo-container {
text-align: center;
padding: 6px 0;
background-color: #ffffff;
border-bottom: 1px solid #ddd;
}
.app-logo {
max-width: 100px;
height: auto;
display: block;
margin: 0 auto;
}
</style>
</head>
<body>
<div id="login-screen" style="display: block;">
<h2>Acesso ao Painel</h2>
<form id="login-form">
<input type="text" id="login-email" placeholder="E-mail" required>
<input type="password" id="login-password" placeholder="Senha" required>
<button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">Entrar</button>
<p id="login-error" style="color: red; margin-top: 10px; display: none;"></p>
</form>
</div>
<div id="app-content">
<nav>
<button id="nav-queue" class="active" onclick="showView('queue')">Fila e Entrada</button>
<button id="nav-production" onclick="showView('production')">Painel de Serviço</button>
<button id="nav-report" onclick="showView('report')">Relatório Diário</button>
<button id="nav-timeclock" onclick="showView('timeclock')">Registro de Ponto</button>
<button id="nav-config" onclick="showView('config')">Administração</button>
<button class="btn-secondary" onclick="handleLogout()" style="margin-left: auto;">Sair</button>
</nav>
<div class="logo-container">
<img src="https://caa-al.org.br/img/convenios/446_logo.jpg?w=250&fit=crop&ud=1760605299" alt="Logo da Clínica" class="app-logo">
</div>
<div id="view-queue" class="view-container">
<div class="container">
<div class="panel-column">
<div class="admin-section">
<h3>Registrar Entrada do Veículo (Fila)</h3>
<form id="new-queue-form">
<label for="queue-car-plate">Placa do Carro:</label>
<input type="text" id="queue-car-plate" required>
<label for="queue-car-model">Modelo do Carro:</label>
<input type="text" id="queue-car-model" required>
<label>Categoria(s) de Serviço(s) a Realizar:</label>
<div id="queue-category-selection" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; border: 1px solid #eee; padding: 10px; border-radius: 4px;">
    <div>
        <input type="checkbox" name="queue-category" value="MECHANIC" id="q-mech" style="width: auto;">
        <label for="q-mech">Serviço Mecânico Geral</label>
    </div>
    <div>
        <input type="checkbox" name="queue-category" value="ALIGNER" id="q-aligner" style="width: auto;">
        <label for="q-aligner">Alinhamento</label>
    </div>
    <div>
        <input type="checkbox" name="queue-category" value="BALANCER" id="q-balancer" style="width: auto;">
        <label for="q-balancer">Balanceamento</label>
    </div>
</div>
<button type="submit" class="btn-primary" style="margin-top: 15px;">Adicionar à Fila</button>
</form>
</div>
</div>
<div class="panel-column">
<h3 style="margin-top: 0; margin-bottom: 10px; border-bottom: none;">Fila de Espera Categorizada</h3>
<div id="categorized-queues-container">
<div>
<h4 style="color: #007bff; border-bottom: 1px dashed #007bff; padding-bottom: 5px;">Serviço Mecânico</h4>
<div id="queue-list-mechanic" class="inner-scroll-list"></div>
</div>
<div>
<h4 style="color: #28a745; border-bottom: 1px dashed #28a745; padding-bottom: 5px;">Alinhamento</h4>
<div id="queue-list-aligner" class="inner-scroll-list"></div>
</div>
<div>
<h4 style="color: #ffc107; border-bottom: 1px dashed #ffc107; padding-bottom: 5px;">Balanceamento</h4>
<div id="queue-list-balancer" class="inner-scroll-list"></div>
</div>
</div>
</div>
</div>
</div>
<div id="view-production" class="view-container">
<div class="container">
<div class="panel-column">
<div class="admin-section">
<h3>Iniciar Serviço (da Fila)</h3>
<p style="font-style: italic; font-size: 14px; margin-top: -10px; margin-bottom: 15px;">
Selecione um carro da Fila para carregar os dados.
</p>
<form id="new-service-form">
<label for="car-plate">Placa do Carro:</label>
<input type="text" id="car-plate" required readonly style="background: #eee;">
<label for="car-model">Modelo do Carro:</label>
<input type="text" id="car-model" required readonly style="background: #eee;">
<label for="queue-service-to-start-select">Serviço a Iniciar:</label>
<select id="queue-service-to-start-select" required>
<option value="">-- Selecione um carro da fila --</option>
</select>
<label for="mechanic-select">Funcionário Disponível:</label>
<select id="mechanic-select" required>
<option value="">-- Selecione um Funcionário --</option>
</select>
<button type="submit" id="play-button" class="btn-play" disabled>▶ Iniciar Serviço</button>
<input type="hidden" id="hidden-queue-item-id">
</form>
</div>
</div>
<div class="panel-column">
<h3 style="margin-top: 0; margin-bottom: 0;">Funcionários Disponíveis</h3>
<div id="available-mechanics-section">
<h4>Mecânicos Gerais</h4>
<div id="mechanic-list-general" class="available-list-group"></div>
<h4>Alinhadores</h4>
<div id="mechanic-list-aligner" class="available-list-group"></div>
<h4>Balanceadores</h4>
<div id="mechanic-list-balancer" class="available-list-group"></div>
</div>
</div>
<div class="panel-column">
<h3 style="margin-top: 0; margin-bottom: 0;">Serviços em Andamento</h3>
<div id="in-progress-list" class="service-list inner-scroll-list">
</div>
</div>
</div>
</div>
<div id="view-report" class="view-container">
<div id="report-header">
<h2>Relatório Diário: <span id="report-date"></span></h2>
<button id="btn-clear-report" class="btn-delete">Limpar Histórico Completo</button>
</div>
<div id="report-list">
</div>
</div>
<div id="view-timeclock" class="view-container">
<h2>Registro de Ponto</h2>
<div id="timeclock-list" class="timeclock-list">
</div>
</div>
<div id="view-config" class="view-container">
<h2>Administração</h2>
<div class="config-container">
<div class="admin-section">
<h3>Gerenciar Funcionários</h3>
<form id="new-mechanic-form" class="admin-form">
<input type="text" id="input-mechanic-name" placeholder="Nome do Funcionário" required>
<select id="select-mechanic-role" required>
<option value="MECHANIC">Mecânico Geral</option>
<option value="ALIGNER">Alinhador</option>
<option value="BALANCER">Balanceador</option>
</select>
<button type="submit" class="btn-primary">Adicionar Funcionário</button>
</form>
<div class="admin-list" id="admin-mechanics-list">
<ul></ul>
</div>
</div>
<div class="admin-section">
<h3>Gerenciar Serviços</h3>
<form id="new-service-config-form" class="admin-form">
<input type="text" id="input-service-name" placeholder="Nome do Serviço (Ex: Troca de Pneu)" required>
<select id="select-service-role" required>
<option value="MECHANIC">Requer Mecânico Geral</option>
<option value="ALIGNER">Requer Alinhador</option>
<option value="BALANCER">Requer Balanceador</option>
</select>
<button type="submit" class="btn-primary">Adicionar Serviço</button>
</form>
<div class="admin-list" id="admin-services-list">
<ul></ul>
</div>
</div>
</div>
</div>
<script>
// ******************************************************
// *** 1. CONFIGURAÇÃO E INICIALIZAÇÃO DO FIREBASE ***
// ******************************************************
// Seu web app's Firebase configuration
const firebaseConfig = {
apiKey: "AIzaSyB6XbdcQyKiZYtVXXwAxRI8cv90GhT-bD8",
authDomain: "painelprodutividade-dd513.firebaseapp.com",
projectId: "painelprodutividade-dd513",
storageBucket: "painelprodutividade-dd513.firebaseapp.com",
messagingSenderId: "535369536853",
appId: "1:535369536853:web:4d0755d7470b026fa64bdc",
};
// Inicializa o Firebase (v9.6.1 de Compatibilidade)
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
// NOVOS ELEMENTOS DOM PARA LOGIN
const loginScreen = document.getElementById('login-screen');
const appContent = document.getElementById('app-content');
const loginForm = document.getElementById('login-form');
const loginEmail = document.getElementById('login-email');
const loginPassword = document.getElementById('login-password');
const loginError = document.getElementById('login-error');
// Nomes das "Coleções" no Firestore
const C_MECHANICS = 'mechanics';
const C_SERVICES = 'services';
const C_QUEUE_SERVICES = 'queue_services';
const C_ACTIVE = 'activeServices';
const C_COMPLETED = 'completedServices';
const C_TIMECLOCK = 'timeclock'; 
// === ESTADO DA APLICAÇÃO (Dados em memória para uso no frontend) ===
let activeTimers = {};
let ALL_MECHANICS = [];
let ALL_SERVICES = [];
let CURRENT_USER = null;
const ALL_QUEUE = [];
window.ACTIVE_SERVICES = []; 
// === CONSTANTES E ELEMENTOS DO DOM ===
const ROLES = {
MECHANIC: 'Mecânico Geral',
ALIGNER: 'Alinhador',
BALANCER: 'Balanceador'
};
// VIEWS
const viewQueue = document.getElementById('view-queue');
const viewProduction = document.getElementById('view-production');
const viewReport = document.getElementById('view-report');
const viewTimeclock = document.getElementById('view-timeclock');
const viewConfig = document.getElementById('view-config');
// BOTÕES DE NAVEGAÇÃO
const navQueue = document.getElementById('nav-queue');
const navProduction = document.getElementById('nav-production');
const navReport = document.getElementById('nav-report');
const navTimeclock = document.getElementById('nav-timeclock');
const navConfig = document.getElementById('nav-config');
// ELEMENTOS DA FILA
const queueForm = document.getElementById('new-queue-form');
const queueCarPlateInput = document.getElementById('queue-car-plate');
const queueCarModelInput = document.getElementById('queue-car-model');
// Filas Categorizadas
const queueListMechanic = document.getElementById('queue-list-mechanic');
const queueListAligner = document.getElementById('queue-list-aligner');
const queueListBalancer = document.getElementById('queue-list-balancer');
// ELEMENTOS DE PRODUÇÃO
const mechanicSelect = document.getElementById('mechanic-select');
const queueServiceToStartSelect = document.getElementById('queue-service-to-start-select');
const hiddenQueueItemId = document.getElementById('hidden-queue-item-id');
const carPlateInput = document.getElementById('car-plate');
const carModelInput = document.getElementById('car-model');
const playButton = document.getElementById('play-button');
const newServiceForm = document.getElementById('new-service-form');
const inProgressList = document.getElementById('in-progress-list');
const availableMechanicsList = document.getElementById('mechanic-list-general');
const availableAlignersList = document.getElementById('mechanic-list-aligner');
const availableBalancersList = document.getElementById('mechanic-list-balancer');
// ELEMENTOS DE ADMIN
const formMechanics = document.getElementById('new-mechanic-form');
const inputMechanicName = document.getElementById('input-mechanic-name');
const selectMechanicRole = document.getElementById('select-mechanic-role');
const adminMechanicsList = document.getElementById('admin-mechanics-list');
const formServices = document.getElementById('new-service-config-form');
const inputServiceName = document.getElementById('input-service-name');
const selectServiceRole = document.getElementById('select-service-role');
const adminServicesList = document.getElementById('admin-services-list');
const timeclockList = document.getElementById('timeclock-list');
const reportList = document.getElementById('report-list');
const reportDateSpan = document.getElementById('report-date');
const btnClearReport = document.getElementById('btn-clear-report');
// ===============================================
// === FUNÇÕES DE UTILIDADE E AUXILIARES ===
// ===============================================
function getRoleDisplayName(roleKey) {
return ROLES[roleKey] || roleKey;
}
function isToday(timestamp) {
const date = new Date(timestamp);
const today = new Date();
return date.getDate() === today.getDate() && date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear();
}
function formatTime(totalSeconds) {
const hours = Math.floor(totalSeconds / 3600);
const minutes = Math.floor((totalSeconds % 3600) / 60);
const seconds = totalSeconds % 60;
return [hours, minutes, seconds].map(unit => String(unit).padStart(2, '0')).join(':');
}
function getMechanicStatus(mechanic) {
if (mechanic.isAvailable === true) {
return { text: "DISPONÍVEL", class: "status-on" };
}
if (mechanic.isAvailable === false && mechanic.queueTime) {
return { text: "FORA / PAUSA", class: "status-break" };
}
return { text: "FORA DE EXPEDIENTE", class: "status-off" };
}
function getServiceDetails(serviceId) {
const service = ALL_SERVICES.find(s => s.fbId === serviceId);
return { name: service ? service.name : 'Serviço Desconhecido', role: service ? service.role : 'MECHANIC' };
}
// *** NOVAS FUNÇÕES DE INTERAÇÃO COM FIREBASE ***
async function addToDB(collectionName, data) {
try {
return await db.collection(collectionName).add(data);
} catch (error) {
console.error(`Erro ao adicionar em ${collectionName}:`, error);
throw new Error("Falha na comunicação com o banco de dados.");
}
}
async function updateDB(collectionName, fbId, data) {
try {
return await db.collection(collectionName).doc(fbId).update(data);
} catch (error) {
console.error(`Erro ao atualizar ${collectionName}/${fbId}:`, error);
throw new Error("Falha na comunicação com o banco de dados.");
}
}
async function deleteFromDB(collectionName, fbId) {
try {
return await db.collection(collectionName).doc(fbId).delete();
} catch (error) {
console.error(`Erro ao deletar ${collectionName}/${fbId}:`, error);
throw new Error("Falha na comunicação com o banco de dados.");
}
}
// ===============================================
// === LÓGICA DE LOGIN E AUTENTICAÇÃO ===
// ===============================================
function showLoginScreen() {
loginScreen.style.display = 'block';
appContent.style.display = 'none';
}
function showAppContent() {
loginScreen.style.display = 'none';
appContent.style.display = 'block';
showView('queue'); // Padrão
}
async function handleLogin(event) {
event.preventDefault();
const email = loginEmail.value;
const password = loginPassword.value;
loginError.style.display = 'none';
try {
await auth.signInWithEmailAndPassword(email, password);
// O observador onAuthStateChanged (initializeApp) lidará com a transição
} catch (error) {
loginError.textContent = "Erro de login: E-mail ou senha inválidos.";
loginError.style.display = 'block';
console.error("Login Error:", error);
}
}
function handleLogout() {
if (confirm("Você realmente deseja sair da aplicação?")) {
auth.signOut();
}
}
// ===============================================
// === LÓGICA DE NAVEGAÇÃO E LISTENERS ===
// ===============================================
function showView(viewId) {
// 1. Esconder todas as views
[viewQueue, viewProduction, viewReport, viewTimeclock, viewConfig].forEach(v => v.style.display = 'none');
// 2. Remover a classe 'active' de todos os botões
[navQueue, navProduction, navReport, navTimeclock, navConfig].forEach(n => n.classList.remove('active'));
const navElement = document.getElementById(`nav-${viewId}`);
if (viewId === 'queue') {
viewQueue.style.display = 'block';
} else if (viewId === 'production') {
viewProduction.style.display = 'block';
} else if (viewId === 'report') {
viewReport.style.display = 'block';
renderDailyReport();
} else if (viewId === 'timeclock') {
viewTimeclock.style.display = 'block';
renderTimeclockCards();
} else if (viewId === 'config') {
viewConfig.style.display = 'block';
renderAdminLists();
}
if (navElement) {
navElement.classList.add('active');
}
}
function setupFirebaseListeners() {
// 1. LISTENERS MASTER (Funcionários e Serviços)
db.collection(C_MECHANICS).orderBy('name').onSnapshot(snapshot => {
ALL_MECHANICS = snapshot.docs.map(doc => ({ fbId: doc.id, ...doc.data() }));
// Atualiza a visualização do Painel, Ponto e Admin
updateAvailableMechanics(window.ACTIVE_SERVICES || []);
if (viewTimeclock.style.display === 'block') renderTimeclockCards();
if (viewConfig.style.display === 'block') renderAdminMechanics();
});
// NOVO: Listener para a FILA DE SERVIÇOS (C_QUEUE_SERVICES)
db.collection(C_QUEUE_SERVICES).orderBy('queuedAt').onSnapshot(snapshot => {
ALL_QUEUE.length = 0; // Limpa o array
snapshot.forEach(doc => {
ALL_QUEUE.push({ fbId: doc.id, ...doc.data() });
});
// Renderiza a fila CATEGORIZADA
renderCategorizedQueueList();
});
db.collection(C_SERVICES).orderBy('name').onSnapshot(snapshot => {
ALL_SERVICES.length = 0; // Limpa o array
snapshot.forEach(doc => {
ALL_SERVICES.push({ fbId: doc.id, ...doc.data() });
});
if (viewConfig.style.display === 'block') renderAdminServices();
});
// 2. LISTENER DE SERVIÇOS ATIVOS (Tempo Real)
db.collection(C_ACTIVE).onSnapshot(snapshot => {
const activeServices = snapshot.docs.map(doc => ({ fbId: doc.id, ...doc.data() }));
window.ACTIVE_SERVICES = activeServices; // Salva na memória global
renderActiveServices(activeServices);
updateAvailableMechanics(activeServices);
});
// 3. LISTENERS DO REGISTRO DE PONTO (TIMECLOCK)
db.collection(C_TIMECLOCK).onSnapshot(snapshot => {
// Nada de global, apenas renderiza na view de ponto
if (viewTimeclock.style.display === 'block') renderTimeclockCards();
});
}
// ===============================================
// === LÓGICA DA FILA E PRODUÇÃO ===
// ===============================================
// NOVO: Cria o HTML para um item da fila com base nos dados.
function createQueueItemHtml(item) {
// Usa uma verificação defensiva para requiredRoles
const requiredRoles = (item.requiredRoles && Array.isArray(item.requiredRoles)) ? item.requiredRoles : [];
// Pega a lista de nomes dos ROLES requeridos (para exibição)
const roleNames = requiredRoles.map(role => ROLES[role] || 'Desconhecido').join(', ');
const queueDate = new Date(item.queuedAt);
return `
<div class="queue-item" data-fbid="${item.fbId}">
<p><strong>Placa:</strong> ${item.carPlate}</p>
<p><strong>Modelo:</strong> ${item.carModel}</p>
<p><strong>Requer:</strong> <small>${roleNames || 'Nenhum serviço especificado'}</small></p>
<p><small>Em fila desde: ${queueDate.toLocaleTimeString('pt-BR')}</small></p>
<button class="btn-primary start-queue-item-btn">Iniciar Serviço</button>
</div>
`;
}
// CORRIGIDO E ROBUSTECIDO: Filtra a fila em 3 listas e renderiza 
function renderCategorizedQueueList() {
// Limpa todas as listas primeiro
[queueListMechanic, queueListAligner, queueListBalancer].forEach(el => el.innerHTML = '<p style="font-style: italic; color: #777; padding: 10px;">Nenhum veículo nesta fila.</p>');
if (ALL_QUEUE.length === 0) return;
// Mapeamento de Filas
const queueMaps = {
'MECHANIC': { element: queueListMechanic, items: [] },
'ALIGNER': { element: queueListAligner, items: [] },
'BALANCER': { element: queueListBalancer, items: [] }
};
ALL_QUEUE.forEach(item => {
const itemHtml = createQueueItemHtml(item);
const requiredRoles = (item.requiredRoles && Array.isArray(item.requiredRoles)) ? item.requiredRoles : [];
// Um item aparece em todas as filas para as quais ele tem um role requerido
requiredRoles.forEach(role => {
if (queueMaps[role]) {
queueMaps[role].items.push({ html: itemHtml, fbId: item.fbId }); 
}
});
});
// Renderiza e anexa os listeners
for (const role in queueMaps) {
const map = queueMaps[role];
map.element.innerHTML = '';
if (map.items.length === 0) {
map.element.innerHTML = '<p style="font-style: italic; color: #777; padding: 10px;">Nenhum veículo nesta fila.</p>';
continue;
}
map.items.forEach(itemData => {
// CORREÇÃO DEFINITIVA DO TYPERROR (usando DOMParser)
const parser = new DOMParser();
const doc = parser.parseFromString(itemData.html, 'text/html');
const itemElement = doc.body.firstElementChild; 
if (itemElement) {
// Anexa o listener ao botão
itemElement.querySelector('.start-queue-item-btn').addEventListener('click', () => handleStartFromQueue(itemData.fbId));
map.element.appendChild(itemElement);
} else {
console.warn("Falha ao processar HTML do item de fila:", itemData.html);
}
});
}
}
// Lida com a entrada de veículo
async function handleAddToQueue(event) {
event.preventDefault();
const carPlate = queueCarPlateInput.value.trim().toUpperCase();
const carModel = queueCarModelInput.value.trim();
// CORREÇÃO: Pega os valores dos checkboxes de CATEGORIA (role)
const checkedCheckboxes = document.querySelectorAll('input[name="queue-category"]:checked');
const requiredRoles = Array.from(checkedCheckboxes).map(cb => cb.value);
if (requiredRoles.length === 0) {
alert("Selecione ao menos uma categoria de serviço para adicionar à fila.");
return;
}
// Nesta versão, não precisamos de serviceIds no objeto da fila, apenas dos roles.
// O serviceIds será filtrado na hora de iniciar o serviço.
const queueData = {
carPlate: carPlate,
carModel: carModel,
// serviceIds: selectedServiceIds, // Removido para simplificar
requiredRoles: requiredRoles,
queuedAt: new Date().getTime(), // Usando Timestamp em milissegundos (number)
addedBy: CURRENT_USER
};
try {
await addToDB(C_QUEUE_SERVICES, queueData);
// Limpa o formulário
queueCarPlateInput.value = '';
queueCarModelInput.value = '';
checkedCheckboxes.forEach(cb => cb.checked = false); // Desmarca
} catch (error) {
alert("Erro ao adicionar o veículo à fila. Verifique a conexão com o Firebase.");
console.error("Erro ao adicionar à fila:", error);
}
}
// Lógica de Carregamento de Formulário de Início
async function handleStartFromQueue(queueFbId) {
const queueItem = ALL_QUEUE.find(item => item.fbId === queueFbId);
if (!queueItem) {
alert("Item da fila não encontrado.");
return;
}
// 1. Muda para a view de Produção
showView('production');
// 2. Copia os dados para o formulário de Iniciar Novo Serviço
carPlateInput.value = queueItem.carPlate;
carModelInput.value = queueItem.carModel;
hiddenQueueItemId.value = queueFbId; // Guarda o ID
// 3. Popula o select SÓ com os serviços que pertencem às categorias do item da fila
queueServiceToStartSelect.innerHTML = '<option value="">-- Selecione um Serviço --</option>';
const requiredRoles = (queueItem.requiredRoles && Array.isArray(queueItem.requiredRoles)) ? queueItem.requiredRoles : [];
// Filtra TODOS os serviços cadastrados que têm um ROLE correspondente ao que está na fila
const availableServices = ALL_SERVICES.filter(service => 
    requiredRoles.includes(service.role)
);
if (availableServices.length === 0) {
    queueServiceToStartSelect.innerHTML = '<option value="">-- Nenhum serviço cadastrado para esta categoria --</option>';
}
availableServices.forEach(service => {
    queueServiceToStartSelect.innerHTML += `<option value="${service.fbId}" data-name="${service.name}" data-role="${service.role}">${service.name}</option>`;
});
// 4. (Opcional) Tenta pré-selecionar o primeiro e disparar a validação
if (availableServices.length > 0) {
queueServiceToStartSelect.value = availableServices[0].fbId;
}
validateForm(); // Valida o formulário de início
// Chama populateMechanicSelect para que o dropdown de mecânicos seja preenchido corretamente
populateMechanicSelect(); 
}
// Adiciona um listener para o select de serviço para que o select de mecânico seja atualizado
queueServiceToStartSelect.addEventListener('change', () => {
populateMechanicSelect();
validateForm();
});
// Popula o select de Funcionário Disponível com base no Serviço Selecionado
function populateMechanicSelect() {
const selectedOption = queueServiceToStartSelect.options[queueServiceToStartSelect.selectedIndex];
const requiredRole = selectedOption ? selectedOption.dataset.role : '';
mechanicSelect.innerHTML = '<option value="">-- Selecione um Funcionário --</option>';
// Filtra funcionários disponíveis pelo cargo necessário
// Filtra apenas os que estão isAvailable: true
const availableMechanics = ALL_MECHANICS.filter(m => 
m.role === requiredRole && m.isAvailable === true
);
availableMechanics.forEach(mechanic => {
mechanicSelect.innerHTML += `<option value="${mechanic.fbId}" data-name="${mechanic.name}">${mechanic.name} (${ROLES[mechanic.role]})</option>`;
});
}
// Habilita/Desabilita o botão Iniciar Serviço
function validateForm() {
const isServiceSelected = queueServiceToStartSelect.value !== "";
const isMechanicSelected = mechanicSelect.value !== "";
const isQueueItemLoaded = carPlateInput.value !== ""; // Garante que é um item da fila
if (isServiceSelected && isMechanicSelected && isQueueItemLoaded) {
playButton.disabled = false;
} else {
playButton.disabled = true;
}
}
// Lógica de Início de Serviço
async function handleStartService(event) {
event.preventDefault();
const serviceId = queueServiceToStartSelect.value;
const mechanicId = mechanicSelect.value;
const queueFbId = hiddenQueueItemId.value;
const serviceName = queueServiceToStartSelect.options[queueServiceToStartSelect.selectedIndex].dataset.name;
const carPlate = carPlateInput.value;
const carModel = carModelInput.value;
const mechanicName = mechanicSelect.options[mechanicSelect.selectedIndex].dataset.name;
if (!serviceId || !mechanicId || !queueFbId) {
alert("Erro de dados. Carregue um item da fila e selecione funcionário/serviço.");
return;
}
const activeData = {
carPlate,
carModel,
serviceId,
serviceName,
mechanicId,
mechanicName,
startTime: new Date().getTime(),
status: 'IN_PROGRESS'
};
try {
// 1. Adiciona o Serviço Ativo
await addToDB(C_ACTIVE, activeData);
// 2. Remove da Fila
await deleteFromDB(C_QUEUE_SERVICES, queueFbId);
// 3. Define o Mecânico como Ocupado
await updateDB(C_MECHANICS, mechanicId, { isAvailable: false, activeService: serviceName });
// 4. Limpa o formulário de Início
newServiceForm.reset();
playButton.disabled = true;
queueServiceToStartSelect.innerHTML = '<option value="">-- Selecione um carro da fila --</option>';
mechanicSelect.innerHTML = '<option value="">-- Selecione um Funcionário --</option>';
} catch (error) {
alert("Erro ao iniciar o serviço. Verifique a conexão com o Firebase.");
console.error("Erro ao iniciar o serviço:", error);
}
}
// Lógica de Parada de Serviço
async function handleStopService(serviceFbId, mechanicId) {
if (!confirm("Tem certeza que deseja finalizar este serviço?")) {
return;
}
const service = window.ACTIVE_SERVICES.find(s => s.fbId === serviceFbId);
if (!service) return;
const stopTime = new Date().getTime();
const durationMs = stopTime - service.startTime;
const durationSeconds = Math.round(durationMs / 1000);
const completedData = {
...service,
stopTime,
durationSeconds,
status: 'COMPLETED',
completedBy: CURRENT_USER,
completedAt: stopTime
};
try {
// 1. Move para a coleção de Concluídos
await addToDB(C_COMPLETED, completedData);
// 2. Remove da coleção de Ativos
await deleteFromDB(C_ACTIVE, serviceFbId);
// 3. Define o Mecânico como Disponível
await updateDB(C_MECHANICS, mechanicId, { isAvailable: true, activeService: null });
// 4. Limpa o timer
clearInterval(activeTimers[serviceFbId]);
delete activeTimers[serviceFbId];
} catch (error) {
alert("Erro ao finalizar o serviço. Verifique a conexão com o Firebase.");
console.error("Erro ao finalizar o serviço:", error);
}
}
// Renderiza a lista de serviços ativos
function renderActiveServices(services) {
inProgressList.innerHTML = services.length === 0 
? '<p style="font-style: italic; color: #777; padding: 10px;">Nenhum serviço em andamento.</p>'
: '';
// Remove timers antigos não mais ativos
Object.keys(activeTimers).forEach(fbId => {
if (!services.some(s => s.fbId === fbId)) {
clearInterval(activeTimers[fbId]);
delete activeTimers[fbId];
}
});
services.forEach(service => {
const existingRow = document.querySelector(`.service-row[data-fbid="${service.fbId}"]`);
// Se a linha não existe, cria (e limpa o timer, caso exista)
if (!existingRow) {
const row = document.createElement('div');
row.className = 'service-row';
row.dataset.fbid = service.fbId;
row.innerHTML = `
<strong>${service.mechanicName}</strong>
<span class="service-desc">${service.serviceName} (${service.carPlate})</span>
<span class="time-started">Início: ${new Date(service.startTime).toLocaleTimeString('pt-BR')}</span>
<span class="time-display" data-fbid="${service.fbId}">00:00:00</span>
<button class="btn-stop" onclick="handleStopService('${service.fbId}', '${service.mechanicId}')">◼ Finalizar</button>
`;
inProgressList.appendChild(row);
}
// Configura ou reseta o timer
if (activeTimers[service.fbId]) {
clearInterval(activeTimers[service.fbId]);
}
const timerElement = document.querySelector(`.time-display[data-fbid="${service.fbId}"]`);
if (timerElement) {
activeTimers[service.fbId] = setInterval(() => {
const elapsedSeconds = Math.round((new Date().getTime() - service.startTime) / 1000);
timerElement.textContent = formatTime(elapsedSeconds);
}, 1000);
}
});
}
// Renderiza a lista de funcionários disponíveis no painel de Produção
function updateAvailableMechanics(activeServices) {
[availableMechanicsList, availableAlignersList, availableBalancersList].forEach(list => list.innerHTML = '');
const rodizioSort = (a, b) => {
// Garante que quem tem 'queueTime' mais baixo (mais tempo esperando) venha primeiro
return (a.queueTime || 0) - (b.queueTime || 0);
};
ALL_MECHANICS.sort(rodizioSort);
ALL_MECHANICS.forEach(mechanic => {
// Verifica se o mecânico está ativo em algum serviço
const activeService = activeServices.find(s => s.mechanicId === mechanic.fbId);
let statusText = mechanic.isAvailable ? 'DISPONÍVEL' : 'FORA / PAUSA';
let statusClass = mechanic.isAvailable ? 'position' : 'position-break';
let displayList;
if (activeService) {
statusText = `OCUPADO: ${activeService.serviceName}`;
statusClass = 'position-busy'; 
} else if (mechanic.isAvailable) {
statusText = 'DISPONÍVEL';
statusClass = 'position';
}
// Seleciona a lista correta
if (mechanic.role === 'MECHANIC') {
displayList = availableMechanicsList;
} else if (mechanic.role === 'ALIGNER') {
displayList = availableAlignersList;
} else if (mechanic.role === 'BALANCER') {
displayList = availableBalancersList;
} else {
return;
}
const tag = document.createElement('div');
tag.className = 'mechanic-tag';
if (!activeService && mechanic.isAvailable) { // Adiciona destaque ao primeiro disponível
// Lógica para encontrar o primeiro disponível (simplesmente pega o primeiro do array já ordenado)
const availableGroup = ALL_MECHANICS.filter(m => m.role === mechanic.role && m.isAvailable && !activeServices.some(s => s.mechanicId === m.fbId));
if (availableGroup[0] && availableGroup[0].fbId === mechanic.fbId) {
tag.classList.add('first-available');
}
}
tag.innerHTML = `
<span>${mechanic.name}</span>
<span class="${statusClass}">${statusText}</span>
`;
displayList.appendChild(tag);
});
// Chama populateMechanicSelect para garantir que a lista de seleção do form esteja correta
populateMechanicSelect();
}
// ===============================================
// === LÓGICA DE ADMINISTRAÇÃO E CONFIG ===
// ===============================================
function renderAdminLists() {
renderAdminMechanics();
renderAdminServices();
}
// Lógica de Adicionar Funcionário
async function handleAddMechanic(event) {
event.preventDefault();
const name = inputMechanicName.value.trim();
const role = selectMechanicRole.value;
if (!name || !role) return;
const mechanicData = {
name,
role,
isAvailable: true,
activeService: null,
queueTime: new Date().getTime() // Inicia disponível com o tempo atual de rodízio
};
try {
await addToDB(C_MECHANICS, mechanicData);
formMechanics.reset();
} catch (error) {
alert("Erro ao adicionar funcionário. Verifique o console.");
}
}
// Renderiza a lista de funcionários na administração
function renderAdminMechanics() {
const ul = adminMechanicsList.querySelector('ul');
ul.innerHTML = '';
ALL_MECHANICS.forEach(mechanic => {
const li = document.createElement('li');
li.innerHTML = `
<span>${mechanic.name} (${getRoleDisplayName(mechanic.role)})</span>
<button class="btn-delete" onclick="deleteFromDB('${C_MECHANICS}', '${mechanic.fbId}')">Excluir</button>
`;
ul.appendChild(li);
});
}
// Lógica de Adicionar Serviço
async function handleAddService(event) {
event.preventDefault();
const name = inputServiceName.value.trim();
const role = selectServiceRole.value;
if (!name || !role) return;
const serviceData = {
name,
role
};
try {
await addToDB(C_SERVICES, serviceData);
formServices.reset();
} catch (error) {
alert("Erro ao adicionar serviço. Verifique o console.");
}
}
// Renderiza a lista de serviços na administração
function renderAdminServices() {
const ul = adminServicesList.querySelector('ul');
ul.innerHTML = '';
ALL_SERVICES.forEach(service => {
const li = document.createElement('li');
li.innerHTML = `
<span>${service.name} (Requer ${getRoleDisplayName(service.role)})</span>
<button class="btn-delete" onclick="deleteFromDB('${C_SERVICES}', '${service.fbId}')">Excluir</button>
`;
ul.appendChild(li);
});
}
// ===============================================
// === LÓGICA DO REGISTRO DE PONTO (TIMECLOCK) ===
// ===============================================
async function handleClock(mechanic, action) {
if (!mechanic) return;
// Lógica simples: inverte o status de isAvailable e registra a hora na coleção TIMECLOCK
const isAvailable = (action === 'IN');
const queueTime = isAvailable ? new Date().getTime() : null;
try {
// 1. Atualiza o status do funcionário
await updateDB(C_MECHANICS, mechanic.fbId, { isAvailable, queueTime });
// 2. Registra a ação
const clockData = {
mechanicId: mechanic.fbId,
mechanicName: mechanic.name,
action: action, // 'IN' ou 'OUT'
timestamp: new Date().getTime()
};
await addToDB(C_TIMECLOCK, clockData);
} catch (error) {
alert("Erro ao registrar ponto.");
}
}
// Renderiza os cartões de ponto
function renderTimeclockCards() {
timeclockList.innerHTML = '';
ALL_MECHANICS.forEach(mechanic => {
const status = getMechanicStatus(mechanic);
const card = document.createElement('div');
card.className = 'timeclock-card';
card.innerHTML = `
<h3>${mechanic.name} (${getRoleDisplayName(mechanic.role)})</h3>
<div class="timeclock-status ${status.class}">${status.text}</div>
<div class="timeclock-buttons">
<button class="btn-clock-in" onclick="handleClock(ALL_MECHANICS.find(m => m.fbId === '${mechanic.fbId}'), 'IN')" ${mechanic.isAvailable ? 'disabled' : ''}>Entrada/Volta</button>
<button class="btn-clock-out" onclick="handleClock(ALL_MECHANICS.find(m => m.fbId === '${mechanic.fbId}'), 'OUT')" ${!mechanic.isAvailable ? 'disabled' : ''}>Pausa/Saída</button>
</div>
`;
timeclockList.appendChild(card);
});
}
// ===============================================
// === LÓGICA DE RELATÓRIO DIÁRIO ===
// ===============================================
async function renderDailyReport() {
const today = new Date();
today.setHours(0, 0, 0, 0);
const startOfTodayTimestamp = today.getTime();
reportDateSpan.textContent = today.toLocaleDateString('pt-BR');
reportList.innerHTML = '<p style="font-style: italic; color: #777; padding: 10px;">Carregando relatório...</p>';
try {
// Busca serviços concluídos hoje
const snapshot = await db.collection(C_COMPLETED)
.where('completedAt', '>=', startOfTodayTimestamp)
.orderBy('completedAt', 'desc')
.get();
const completedServices = snapshot.docs.map(doc => ({ fbId: doc.id, ...doc.data() }));
if (completedServices.length === 0) {
reportList.innerHTML = '<p style="font-style: italic; color: #777; padding: 10px;">Nenhum serviço concluído hoje.</p>';
return;
}
// Agrupa por funcionário
const reportByMechanic = completedServices.reduce((acc, service) => {
acc[service.mechanicId] = acc[service.mechanicId] || { name: service.mechanicName, services: [], totalDuration: 0 };
acc[service.mechanicId].services.push(service);
acc[service.mechanicId].totalDuration += service.durationSeconds;
return acc;
}, {});
// Renderiza o relatório
reportList.innerHTML = '';
for (const mechanicId in reportByMechanic) {
const group = reportByMechanic[mechanicId];
const groupElement = document.createElement('div');
groupElement.className = 'mechanic-report-group';
groupElement.innerHTML = `
<h3>${group.name}</h3>
${group.services.map(service => `
<div class="service-report-row">
<span>${service.serviceName} (${service.carPlate})</span>
<span>Início: ${new Date(service.startTime).toLocaleTimeString('pt-BR')}</span>
<span>Fim: ${new Date(service.stopTime).toLocaleTimeString('pt-BR')}</span>
<span>Duração: ${formatTime(service.durationSeconds)}</span>
</div>
`).join('')}
<div class="report-summary">
Total de Serviços: ${group.services.length} | 
Tempo Total Trabalhado: ${formatTime(group.totalDuration)}
</div>
`;
reportList.appendChild(groupElement);
}
} catch (error) {
reportList.innerHTML = '<p style="color: red;">Erro ao carregar o relatório.</p>';
console.error("Erro ao carregar relatório:", error);
}
}
// Lógica para limpar o histórico (Botão Admin)
async function handleClearReport() {
if (!confirm("AVISO! Você tem certeza que deseja APAGAR TODO O HISTÓRICO de serviços concluídos? Esta ação é irreversível.")) {
return;
}
try {
const snapshot = await db.collection(C_COMPLETED).get();
const batch = db.batch();
snapshot.docs.forEach(doc => {
batch.delete(doc.ref);
});
await batch.commit();
alert("Histórico de serviços concluídos apagado com sucesso.");
renderDailyReport(); // Atualiza a visualização
} catch (error) {
alert("Erro ao limpar o histórico.");
console.error("Erro ao limpar histórico:", error);
}
}
// ===============================================
// === INICIALIZAÇÃO DA APLICAÇÃO ===
// ===============================================
function initializeApp() {
auth.onAuthStateChanged(user => {
if (user) {
CURRENT_USER = user.email;
showAppContent();
setupFirebaseListeners();
} else {
CURRENT_USER = null;
showLoginScreen();
}
});
}
document.addEventListener('DOMContentLoaded', () => {
// Setup Listeners de Formulário
document.getElementById('new-service-form').addEventListener('submit', handleStartService);
queueForm.addEventListener('submit', handleAddToQueue); // Listener do formulário de fila
mechanicSelect.addEventListener('change', validateForm);
queueServiceToStartSelect.addEventListener('change', validateForm);
formMechanics.addEventListener('submit', handleAddMechanic);
formServices.addEventListener('submit', handleAddService);
loginForm.addEventListener('submit', handleLogin);
btnClearReport.addEventListener('click', handleClearReport);
initializeApp();
});
</script>
</body>
</html>